//@version=5
indicator("BB Contraction Bounce Detector", overlay=true, max_lines_count=500, max_labels_count=500)

// ============================================================
// åƒæ•¸è¨­å®š
// ============================================================

bb_period = input(20, "BB Period", group="Bollinger Bands")
bb_std = input(2.0, "BB Std Dev", group="Bollinger Bands")

lookahead = input(5, "Lookahead Bars", group="Detection Logic")
min_rebound_15m = input(0.008, "Min Rebound 15m (0.8%)", group="Detection Logic")
min_rebound_1h = input(0.015, "Min Rebound 1h (1.5%)", group="Detection Logic")
max_drawdown_15m = input(-0.005, "Max Drawdown 15m (-0.5%)", group="Detection Logic")
max_drawdown_1h = input(-0.01, "Max Drawdown 1h (-1%)", group="Detection Logic")
bb_contraction_threshold = input(-0.08, "BB Contraction Threshold (-8%)", group="Detection Logic")
bb_expansion_threshold = input(0.05, "BB Expansion Threshold (5%)", group="Detection Logic")

show_bb = input(true, "Show Bollinger Bands", group="Display")
show_signals = input(true, "Show Bounce Signals", group="Display")
show_labels = input(true, "Show Labels", group="Display")

// ============================================================
// è¨ˆç®— Bollinger Bands
// ============================================================

basis = ta.sma(close, bb_period)
dev = bb_std * ta.stdev(close, bb_period)
upper = basis + dev
lower = basis - dev
bb_width = upper - lower
bb_width_sma = ta.sma(bb_width, 5)

// ============================================================
// è¨ˆç®—æ­·å²å¯¬åº¦ç”¨æ–¼ç™¾åˆ†ä½æ•¸
// ============================================================

width_min = ta.lowest(bb_width, 20)
width_max = ta.highest(bb_width, 20)
bb_width_percentile = (bb_width - width_min) / (width_max - width_min + 0.0001)

// ============================================================
// è¨ˆç®— BB å¯¬åº¦è®ŠåŒ–
// ============================================================

bb_width_change_1bar = (bb_width - bb_width[1]) / (bb_width[1] + 0.0001)
bb_width_change_2bar = (bb_width - bb_width[2]) / (bb_width[2] + 0.0001)
bb_width_change_3bar = (bb_width - bb_width[3]) / (bb_width[3] + 0.0001)

// ============================================================
// æª¢æ¸¬åå½ˆæ¢ä»¶
// ============================================================

// æ¢ä»¶ 1: åƒ¹æ ¼æ¥è¿‘ä¸‹è»Œ
price_to_lower = (close - lower) / (upper - lower)
is_near_lower = price_to_lower < 0.20

// æ¢ä»¶ 2: è¨ˆç®—æœªä¾† lookahead æ ¹çš„çµ±è¨ˆ
// (æ³¨æ„: Pine Script ç„¡æ³•å‘å‰çœ‹ï¼Œæˆ‘å€‘ç”¨ç•¶å‰å’Œéå»çš„æ•¸æ“šåå‘æ¨ç†)
// å¯¦éš›ä½¿ç”¨æ™‚æœƒçœ‹éå» 5 æ ¹çš„æ¨¡å¼ï¼Œä¾†åˆ¤æ–·ç•¶å‰æ˜¯å¦ç‚ºåå½ˆèµ·é»

// éå» 3 æ ¹çš„å¹³å‡ BB å¯¬åº¦
past_avg_width = (bb_width + bb_width[1] + bb_width[2]) / 3

// éå» 7-10 æ ¹çš„å¹³å‡ BB å¯¬åº¦ (ä»£è¡¨ã€Œä¹‹å‰çš„å¸¸æ…‹")
long_past_avg_width = (bb_width[3] + bb_width[4] + bb_width[5] + bb_width[6] + bb_width[7]) / 5

// BB å¯¬åº¦è®ŠåŒ– (éå»çŸ­æœŸ vs é•·æœŸ)
width_change_ratio = (past_avg_width - long_past_avg_width) / (long_past_avg_width + 0.0001)

// æ¢ä»¶ 3: æ¨™æº–å·®è®ŠåŒ–
std_dev_current = ta.stdev(close, bb_period)
std_dev_past = ta.stdev(close[3], bb_period)
std_change = (std_dev_current - std_dev_past) / (std_dev_past + 0.0001)

// æ¢ä»¶ 4: æˆäº¤é‡
volume_ratio = volume / ta.sma(volume, 30)

// æ¢ä»¶ 5: RSI (å‹•é‡)
rsi = ta.rsi(close, 14)

// æ¢ä»¶ 6: æœ€è¿‘ K æ£’çš„æœ€å°å€¼ (æª¢æŸ¥æ˜¯å¦æ›¾å¤§å¹…å›æ’¤)
recent_low = ta.lowest(close, 5)
recent_high = ta.highest(close, 5)
recent_range = (recent_high - recent_low) / (close + 0.0001)

// ============================================================
// åå½ˆä¿¡è™Ÿé‚è¼¯
// ============================================================

// ä¿¡è™Ÿ 1: å¼·æœ‰æ•ˆåå½ˆ
// - æ¥è¿‘ä¸‹è»Œ
// - BB æ˜é¡¯æ”¶ç¸®ï¼ˆéå»è®Šå¯¬ï¼Œç¾åœ¨è®Šçª„ï¼‰
// - æ¨™æº–å·®ä¸‹é™
// - å¯èƒ½æœ‰æˆäº¤é‡é€²å ´
strong_contraction = width_change_ratio < bb_contraction_threshold and std_change < 0
strong_signal = is_near_lower and strong_contraction and volume_ratio > 0.8

// ä¿¡è™Ÿ 2: ä¸­ç­‰æœ‰æ•ˆåå½ˆ
// - æ¥è¿‘ä¸‹è»Œ
// - BB å¯¬åº¦åœ¨ä½ä½ (æ­·å²ç™¾åˆ†ä½ < 0.3)
// - æ¨™æº–å·®ç©©å®š
medium_signal = is_near_lower and bb_width_percentile < 0.3 and abs(std_change) < 0.1

// ä¿¡è™Ÿ 3: ç„¡æ•ˆåå½ˆ (åå‘ä¿¡è™Ÿ)
// - æ¥è¿‘ä¸‹è»Œ
// - BB æŒçºŒæ“´å¼µ
// - æ¨™æº–å·®ä¸Šå‡
// - å¾ˆå¯èƒ½ç¹¼çºŒä¸‹è·Œ
invalid_signal = is_near_lower and width_change_ratio > bb_expansion_threshold and std_change > 0.05

// ============================================================
// ç¹ªè£½ Bollinger Bands
// ============================================================

if show_bb
    plot(upper, "BB Upper", color=color.new(color.blue, 50), linewidth=1)
    plot(basis, "BB Middle", color=color.new(color.gray, 50), linewidth=1)
    plot(lower, "BB Lower", color=color.new(color.blue, 50), linewidth=1)
    
    // å¡«å…… BB å¸¶
    fill(plot(upper, "upper_dummy", na), plot(lower, "lower_dummy", na), 
         color=color.new(color.blue, 95), title="BB Fill")

// ============================================================
// ç¹ªè£½ä¿¡è™Ÿ
// ============================================================

if show_signals
    // å¼·åå½ˆä¿¡è™Ÿ (ç¶ è‰²å‘ä¸Šç®­é ­)
    if strong_signal
        plotshape(true, style=shape.arrowup, location=location.belowbar, color=color.new(color.green, 0), size=size.large, title="Strong Bounce Signal")
        if show_labels
            label.new(bar_index, low - (high - low) * 0.5, "Strong Bounce\n(BB Contraction)", color=color.new(color.green, 0), textcolor=color.white, style=label.style_label_up, size=size.small)
    
    // ä¸­ç­‰åå½ˆä¿¡è™Ÿ (æ·ºç¶ è‰²å‘ä¸Šç®­é ­)
    if medium_signal and not strong_signal
        plotshape(true, style=shape.arrowup, location=location.belowbar, color=color.new(color.lime, 0), size=size.normal, title="Medium Bounce Signal")
        if show_labels
            label.new(bar_index, low - (high - low) * 0.3, "Medium Bounce\n(Squeeze)", color=color.new(color.lime, 0), textcolor=color.black, style=label.style_label_up, size=size.small)
    
    // ç„¡æ•ˆåå½ˆä¿¡è™Ÿ (ç´…è‰²å‘ä¸‹ç®­é ­)
    if invalid_signal
        plotshape(true, style=shape.arrowdown, location=location.abovebar, color=color.new(color.red, 0), size=size.large, title="Invalid Bounce Signal")
        if show_labels
            label.new(bar_index, high + (high - low) * 0.5, "Invalid Bounce\n(BB Expanding)", color=color.new(color.red, 0), textcolor=color.white, style=label.style_label_down, size=size.small)

// ============================================================
// è¡¨æ ¼è³‡è¨Šé¢æ¿
// ============================================================

var table info_table = na

if barstate.islast
    if na(info_table)
        info_table := table.new(position=position.top_right, columns=2, rows=8, border_width=2, border_color=color.gray, frame_width=2, frame_color=color.gray)
    
    table.cell(info_table, 0, 0, "BB Width", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 0, str.tostring(bb_width, "#.##"), bgcolor=color.new(color.gray, 20))
    
    table.cell(info_table, 0, 1, "Width Change 2bar", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 1, str.tostring(bb_width_change_2bar * 100, "#.##%"), bgcolor=color.new(color.gray, 20))
    
    table.cell(info_table, 0, 2, "Std Change", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 2, str.tostring(std_change * 100, "#.##%"), bgcolor=color.new(color.gray, 20))
    
    table.cell(info_table, 0, 3, "Width Percentile", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 3, str.tostring(bb_width_percentile * 100, "#.##%"), bgcolor=color.new(color.gray, 20))
    
    table.cell(info_table, 0, 4, "Price to Lower", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 4, str.tostring(price_to_lower * 100, "#.##%"), bgcolor=color.new(color.gray, 20))
    
    table.cell(info_table, 0, 5, "Volume Ratio", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 5, str.tostring(volume_ratio, "#.##x"), bgcolor=color.new(color.gray, 20))
    
    table.cell(info_table, 0, 6, "RSI 14", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 6, str.tostring(rsi, "#.##"), bgcolor=color.new(color.gray, 20))
    
    // ä¿¡è™Ÿç‹€æ…‹
    signal_text = if strong_signal
        "ğŸŸ¢ STRONG BOUNCE"
    else if medium_signal
        "ğŸŸ¡ MEDIUM BOUNCE"
    else if invalid_signal
        "ğŸ”´ INVALID BOUNCE"
    else
        "âšª NO SIGNAL"
    
    table.cell(info_table, 0, 7, "Status", bgcolor=color.gray, text_color=color.white)
    table.cell(info_table, 1, 7, signal_text, bgcolor=color.new(color.gray, 20), text_color=color.white)

// ============================================================
// å‘Šè­¦
// ============================================================

if strong_signal
    alert("Strong Bounce Signal Detected!", alert.freq_once_per_bar)

if invalid_signal
    alert("Invalid Bounce Signal - Caution!", alert.freq_once_per_bar)
