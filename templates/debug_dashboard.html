<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BB Bounce ML V2 - æ¨¡å‹èª¿è©¦å„€è¡¨æ¿</title>
  <style>
    :root {
      --color-white: rgba(255, 255, 255, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-green-500: rgba(34, 197, 94, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-yellow-400: rgba(250, 204, 21, 1);
    }

    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1a202c 100%);
      color: var(--color-gray-200);
    }

    body { padding: 20px; }
    .container { max-width: 1400px; margin: 0 auto; }

    header {
      background: rgba(15, 23, 42, 0.95);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 { margin: 0; font-size: 24px; }
    .status-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
    }
    .status-ok { background: rgba(34, 197, 94, 0.2); color: var(--color-green-500); }
    .status-warning { background: rgba(250, 204, 21, 0.2); color: var(--color-yellow-400); }
    .status-error { background: rgba(255, 84, 89, 0.2); color: var(--color-red-400); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.8);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-200);
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      padding-bottom: 10px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .info-row:last-child { border-bottom: none; }
    .info-label { color: var(--color-gray-300); }
    .info-value { font-weight: 500; color: var(--color-gray-200); }
    .info-value.ok { color: var(--color-green-500); }
    .info-value.error { color: var(--color-red-400); }
    .info-value.warning { color: var(--color-yellow-400); }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }

    th {
      text-align: left;
      padding: 8px;
      background: rgba(50, 184, 198, 0.1);
      color: var(--color-teal-300);
      font-weight: 600;
      border-bottom: 2px solid rgba(50, 184, 198, 0.3);
    }

    td {
      padding: 8px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    tr:hover { background: rgba(50, 184, 198, 0.05); }

    .symbol-status { display: flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }
    .dot.loaded { background: var(--color-green-500); }
    .dot.missing { background: var(--color-red-400); }
    .dot.default { background: var(--color-yellow-400); }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
      font-size: 12px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-green-500), var(--color-teal-400));
      color: #0b1120;
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(34, 197, 94, 0.4); }

    .progress-bar {
      height: 4px;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 4px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-teal-400), var(--color-teal-300));
      transition: width 0.3s;
    }

    .code-block {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #a3e635;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.4;
      max-height: 200px;
      overflow-y: auto;
    }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--color-teal-300);
      border-left: 4px solid var(--color-teal-400);
      padding-left: 12px;
    }

    .warning-box {
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      color: var(--color-yellow-400);
      font-size: 12px;
    }

    .error-box {
      background: rgba(255, 84, 89, 0.1);
      border: 1px solid rgba(255, 84, 89, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      color: var(--color-red-400);
      font-size: 12px;
    }

    .success-box {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 10px 0;
      color: var(--color-green-500);
      font-size: 12px;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
    ::-webkit-scrollbar-thumb { background: rgba(100, 150, 100, 0.5); border-radius: 3px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>BB Bounce ML V2 - æ¨¡å‹èª¿è©¦å„€è¡¨æ¿</h1>
      <button class="btn btn-primary" onclick="refreshDiagnostics()">åˆ·æ–°è¨ºæ–·</button>
    </header>

    <div class="section">
      <div class="section-title">ç³»çµ±ç‹€æ…‹æ¦‚è¦½</div>
      <div class="grid">
        <div class="card">
          <div class="card-title">æœå‹™ç‹€æ…‹</div>
          <div class="info-row">
            <span class="info-label">ä¼ºæœå™¨é€£æ¥:</span>
            <span class="info-value ok" id="server-status">æ­£åœ¨é€£æ¥...</span>
          </div>
          <div class="info-row">
            <span class="info-label">WebSocket:</span>
            <span class="info-value ok" id="websocket-status">æ­£åœ¨é€£æ¥...</span>
          </div>
          <div class="info-row">
            <span class="info-label">æ•¸æ“šæº:</span>
            <span class="info-value ok" id="data-source-status">æª¢æŸ¥ä¸­...</span>
          </div>
        </div>

        <div class="card">
          <div class="card-title">æ¨¡å‹æ¦‚è¦½</div>
          <div class="info-row">
            <span class="info-label">ç›£æ§å¹£ç¨®:</span>
            <span class="info-value" id="total-symbols">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">å·²åŠ è¼‰åˆ†é¡å™¨:</span>
            <span class="info-value" id="loaded-classifiers">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">å·²åŠ è¼‰æœ‰æ•ˆæ€§æ¨¡å‹:</span>
            <span class="info-value" id="loaded-validity">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">æ¨¡å‹åŠ è¼‰ç‡:</span>
            <div style="flex: 1;">
              <div class="progress-bar">
                <div class="progress-fill" id="model-load-progress" style="width: 0%"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ä¿¡è™Ÿçµ±è¨ˆ</div>
          <div class="info-row">
            <span class="info-label">ä»Šæ—¥ä¿¡è™Ÿ:</span>
            <span class="info-value" id="signal-count">0</span>
          </div>
          <div class="info-row">
            <span class="info-label">å¹³å‡ä¿¡å¿ƒåº¦:</span>
            <span class="info-value" id="avg-confidence">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">æœ€é«˜ä¿¡å¿ƒåº¦:</span>
            <span class="info-value" id="max-confidence">-</span>
          </div>
          <div class="info-row">
            <span class="info-label">æœ€ä½ä¿¡å¿ƒåº¦:</span>
            <span class="info-value" id="min-confidence">-</span>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">åˆ†é¡å™¨ (Layer 1) - BB ä½ç½®æª¢æ¸¬</div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>å¹£ç¨®</th>
              <th>åˆ†é¡å™¨ç‹€æ…‹</th>
              <th>æ¨¡å‹æ–‡ä»¶</th>
              <th>ç‰¹å¾µæ•¸</th>
              <th>è¨ºæ–·</th>
            </tr>
          </thead>
          <tbody id="classifier-table"></tbody>
        </table>
      </div>
      <div class="warning-box">
        ğŸ’¡ åˆ†é¡å™¨ç”¨æ–¼æª¢æ¸¬åƒ¹æ ¼æ˜¯å¦æ¥è¿‘ BB ä¸Šä¸‹è»Œã€‚å¦‚æœé¡¯ç¤º "é è¨­å€¼"ï¼Œè¡¨ç¤ºæ¨¡å‹æœªåŠ è¼‰ï¼Œç³»çµ±ä½¿ç”¨å•Ÿç™¼å¼åˆ¤æ–·ã€‚
      </div>
    </div>

    <div class="section">
      <div class="section-title">æœ‰æ•ˆæ€§æ¨¡å‹ (Layer 2) - ä¿¡è™Ÿæœ‰æ•ˆæ€§é©—è­‰</div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>å¹£ç¨®</th>
              <th>æœ‰æ•ˆæ€§æ¨¡å‹ç‹€æ…‹</th>
              <th>æ¨¡å‹æ–‡ä»¶</th>
              <th>ç‰¹å¾µæ•¸</th>
              <th>è¨ºæ–·</th>
            </tr>
          </thead>
          <tbody id="validity-table"></tbody>
        </table>
      </div>
      <div class="warning-box">
        ğŸ’¡ æœ‰æ•ˆæ€§æ¨¡å‹ç”¨æ–¼é©—è­‰ä¿¡è™ŸçœŸå¯¦æ€§ã€‚å¦‚æœé¡¯ç¤º "é è¨­å€¼ (65%)"ï¼Œè¡¨ç¤ºæ¨¡å‹æœªåŠ è¼‰ï¼Œä¿¡å¿ƒåº¦å›ºå®šç‚º 65%ã€‚
      </div>
    </div>

    <div class="section">
      <div class="section-title">å¯¦æ™‚ä¿¡è™Ÿæ¨£æœ¬ (æœ€è¿‘ 10 å€‹)</div>
      <div class="card">
        <table>
          <thead>
            <tr>
              <th>å¹£ç¨®</th>
              <th>æ™‚é–“</th>
              <th>æ–¹å‘</th>
              <th>ä½ç½®</th>
              <th>æœ‰æ•ˆæ€§</th>
              <th>RSI</th>
              <th>ADX</th>
            </tr>
          </thead>
          <tbody id="signals-table"></tbody>
        </table>
      </div>
      <div id="no-signals" class="warning-box">æš«ç„¡ä¿¡è™Ÿ</div>
    </div>

    <div class="section">
      <div class="section-title">è¨ºæ–·å ±å‘Š</div>
      <div class="card">
        <div id="diagnosis-report" class="code-block">ç­‰å¾…è¨ºæ–·...</div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">å¸¸è¦‹å•é¡Œ</div>
      <div class="card">
        <h4 style="margin: 0 0 10px 0; color: var(--color-teal-300);">Q: ç‚ºä»€éº¼æ‰€æœ‰ä¿¡å¿ƒåº¦éƒ½æ˜¯ 65%?</h4>
        <p style="margin: 0; color: var(--color-gray-300); font-size: 12px;">
          A: é€™è¡¨ç¤ºæœ‰æ•ˆæ€§æ¨¡å‹æœªè¢«åŠ è¼‰ã€‚æª¢æŸ¥ models/ æ–‡ä»¶å¤¾ä¸­æ˜¯å¦æœ‰ *_validity_model.pkl æ–‡ä»¶ã€‚
        </p>

        <h4 style="margin: 10px 0 0 0; color: var(--color-teal-300);">Q: å¦‚ä½•ç¢ºèªæ¨¡å‹æ˜¯å¦çœŸçš„è¢«ä½¿ç”¨?</h4>
        <p style="margin: 0; color: var(--color-gray-300); font-size: 12px;">
          A: æŸ¥çœ‹ä¸Šæ–¹çš„åˆ†é¡å™¨è¡¨å’Œæœ‰æ•ˆæ€§æ¨¡å‹è¡¨ã€‚å¦‚æœé¡¯ç¤º "å·²åŠ è¼‰"ï¼Œè¡¨ç¤ºæ¨¡å‹è¢«ä½¿ç”¨ã€‚å¦‚æœé¡¯ç¤º "é è¨­å€¼"ï¼Œç³»çµ±ä½¿ç”¨é»˜èªé‚è¼¯ã€‚
        </p>

        <h4 style="margin: 10px 0 0 0; color: var(--color-teal-300);">Q: ä¿¡å¿ƒåº¦æ‡‰è©²æ˜¯å¤šå°‘æ‰æ­£å¸¸?</h4>
        <p style="margin: 0; color: var(--color-gray-300); font-size: 12px;">
          A: æ­£å¸¸æƒ…æ³ä¸‹æ‡‰è©²åœ¨ 30%-95% ç¯„åœå…§è®ŠåŒ–ã€‚å¦‚æœæ‰€æœ‰éƒ½æ˜¯ 65%ï¼Œèªªæ˜æ¨¡å‹æœªè¢«åŠ è¼‰ã€‚
        </p>

        <h4 style="margin: 10px 0 0 0; color: var(--color-teal-300);">Q: å¦‚ä½•ä¿®å¾©ç¼ºå¤±çš„æ¨¡å‹?</h4>
        <p style="margin: 0; color: var(--color-gray-300); font-size: 12px;">
          A: é‹è¡Œè¨“ç·´è…³æœ¬: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 3px;">python train_models.py</code>
        </p>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    let socket = null;
    let diagnosticData = {};
    let recentSignals = [];

    function initializeSocket() {
      console.log('[Socket] Initializing connection...');
      
      // ç²å–ç•¶å‰ä¸»æ©Ÿå’Œç«¯å£
      const protocol = window.location.protocol === 'https:' ? 'https' : 'http';
      const hostname = window.location.hostname;
      const port = window.location.port || (protocol === 'https' ? 443 : 80);
      
      // å¦‚æœåœ¨ localhost:5000 ä¸Šé–‹ç™¼
      let socketURL = `${protocol}://${hostname}:${port}`;
      
      console.log(`[Socket] Connecting to: ${socketURL}`);
      
      socket = io(socketURL, {
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        reconnectionAttempts: 5,
        transports: ['websocket', 'polling'],
        forceNew: true
      });

      socket.on('connect', onSocketConnect);
      socket.on('disconnect', onSocketDisconnect);
      socket.on('diagnostics_response', onDiagnosticsResponse);
      socket.on('realtime_signal', onRealtimeSignal);
      socket.on('error', onSocketError);
      socket.on('connect_error', onConnectError);
    }

    function onSocketConnect() {
      console.log('[Socket] Connected successfully!');
      updateStatus('server-status', 'å·²é€£æ¥', 'ok');
      updateStatus('websocket-status', 'å·²é€£æ¥', 'ok');
      requestDiagnostics();
    }

    function onSocketDisconnect(reason) {
      console.log('[Socket] Disconnected:', reason);
      updateStatus('server-status', 'å·²æ–·é–‹', 'error');
      updateStatus('websocket-status', 'å·²æ–·é–‹', 'error');
    }

    function onDiagnosticsResponse(data) {
      console.log('[Socket] Received diagnostics:', data);
      diagnosticData = data;
      renderDiagnostics(data);
    }

    function onRealtimeSignal(signal) {
      console.log('[Socket] New signal:', signal);
      recentSignals.unshift(signal);
      if (recentSignals.length > 10) {
        recentSignals.pop();
      }
      updateSignalsTable();
      updateSignalStats();
    }

    function onSocketError(error) {
      console.error('[Socket] Error:', error);
    }

    function onConnectError(error) {
      console.error('[Socket] Connection error:', error);
    }

    function updateStatus(elementId, status, type) {
      const el = document.getElementById(elementId);
      if (el) {
        el.textContent = status;
        el.className = `info-value ${type}`;
      }
    }

    function requestDiagnostics() {
      if (socket && socket.connected) {
        console.log('[Socket] Requesting diagnostics...');
        socket.emit('request_diagnostics', {});
      } else {
        console.warn('[Socket] Not connected, cannot request diagnostics');
      }
    }

    function renderDiagnostics(data) {
      // æ›´æ–°æ¦‚è¦½
      document.getElementById('total-symbols').textContent = data.total_symbols || 0;
      document.getElementById('loaded-classifiers').textContent = `${data.loaded_classifiers || 0}/${data.total_symbols || 0}`;
      document.getElementById('loaded-validity').textContent = `${data.loaded_validity_models || 0}/${data.total_symbols || 0}`;

      const loadRate = data.total_symbols > 0 
        ? ((data.loaded_classifiers + data.loaded_validity_models) / (data.total_symbols * 2) * 100).toFixed(0)
        : 0;
      document.getElementById('model-load-progress').style.width = loadRate + '%';

      // æ›´æ–°æ•¸æ“šæº
      updateStatus('data-source-status', data.data_source || 'æœªçŸ¥', 
        data.data_source === 'Binance US' ? 'ok' : 'warning');

      // åˆ†é¡å™¨è¡¨
      const classifierTable = document.getElementById('classifier-table');
      classifierTable.innerHTML = '';
      (data.classifiers || []).forEach(classifier => {
        const row = document.createElement('tr');
        const isDotLoaded = classifier.status === 'å·²åŠ è¼‰';
        row.innerHTML = `
          <td><strong>${classifier.symbol}</strong></td>
          <td><span class="symbol-status"><div class="dot ${isDotLoaded ? 'loaded' : 'default'}"></div>${classifier.status}</span></td>
          <td style="font-size: 11px; color: var(--color-gray-300);">${classifier.file || 'N/A'}</td>
          <td>${classifier.features || '-'}</td>
          <td style="font-size: 11px;">${classifier.diagnosis || '-'}</td>
        `;
        classifierTable.appendChild(row);
      });

      // æœ‰æ•ˆæ€§æ¨¡å‹è¡¨
      const validityTable = document.getElementById('validity-table');
      validityTable.innerHTML = '';
      (data.validity_models || []).forEach(model => {
        const row = document.createElement('tr');
        const isDotLoaded = model.status === 'å·²åŠ è¼‰';
        row.innerHTML = `
          <td><strong>${model.symbol}</strong></td>
          <td><span class="symbol-status"><div class="dot ${isDotLoaded ? 'loaded' : 'default'}"></div>${model.status}</span></td>
          <td style="font-size: 11px; color: var(--color-gray-300);">${model.file || 'N/A'}</td>
          <td>${model.features || '-'}</td>
          <td style="font-size: 11px;">${model.diagnosis || '-'}</td>
        `;
        validityTable.appendChild(row);
      });

      // è¨ºæ–·å ±å‘Š
      const report = data.diagnostic_report || 'ç„¡æ³•ç”Ÿæˆè¨ºæ–·å ±å‘Š';
      document.getElementById('diagnosis-report').textContent = report;
    }

    function updateSignalsTable() {
      const table = document.getElementById('signals-table');
      const noSignals = document.getElementById('no-signals');

      if (recentSignals.length === 0) {
        table.innerHTML = '';
        noSignals.style.display = 'block';
        return;
      }

      noSignals.style.display = 'none';
      table.innerHTML = recentSignals.map(signal => `
        <tr>
          <td><strong>${signal.symbol}</strong></td>
          <td style="font-size: 11px;">${new Date(signal.timestamp).toLocaleTimeString('zh-TW')}</td>
          <td>${signal.side === 'long' ? 'å¤šé ­ â†‘' : 'ç©ºé ­ â†“'}</td>
          <td>${signal.bb_position_label}</td>
          <td style="color: ${signal.validity_prob >= 0.75 ? 'var(--color-green-500)' : 'var(--color-yellow-400)'};font-weight:600;">
            ${(signal.validity_prob * 100).toFixed(0)}%
          </td>
          <td>${signal.rsi ? signal.rsi.toFixed(1) : '-'}</td>
          <td>${signal.adx ? signal.adx.toFixed(1) : '-'}</td>
        </tr>
      `).join('');
    }

    function updateSignalStats() {
      if (recentSignals.length === 0) {
        document.getElementById('signal-count').textContent = '0';
        document.getElementById('avg-confidence').textContent = '-';
        document.getElementById('max-confidence').textContent = '-';
        document.getElementById('min-confidence').textContent = '-';
        return;
      }

      const confidences = recentSignals.map(s => s.validity_prob);
      const avg = (confidences.reduce((a, b) => a + b, 0) / confidences.length * 100).toFixed(0);
      const max = (Math.max(...confidences) * 100).toFixed(0);
      const min = (Math.min(...confidences) * 100).toFixed(0);

      document.getElementById('signal-count').textContent = recentSignals.length;
      document.getElementById('avg-confidence').textContent = avg + '%';
      document.getElementById('max-confidence').textContent = max + '%';
      document.getElementById('min-confidence').textContent = min + '%';
    }

    function refreshDiagnostics() {
      console.log('[UI] Refreshing diagnostics...');
      requestDiagnostics();
    }

    // åˆå§‹åŒ–
    console.log('[App] Initializing debug dashboard...');
    initializeSocket();
    updateSignalsTable();
    updateSignalStats();

    // æ¯ 10 ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡è¨ºæ–·
    setInterval(() => {
      if (socket && socket.connected) {
        requestDiagnostics();
      }
    }, 10000);
  </script>
</body>
</html>